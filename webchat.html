<!DOCTYPE html>
<html>
  <head>
    <style> 

    #rcorners {
      border-radius: 20px;
      border: 2px solid #808080;
      padding: 20px; 
      height: 90vh;
      display: flex;
      justify-content:space-between;
      flex-direction:column;
    }
    #wrapper {
      display: flex;
      flex-direction: row;
      width: 100%;
      height: 50px;
      margin: 0 auto;
    }
    #area {
      height: 100%;
    }

    #popup {
      display: block;
      position: fixed;
      z-index: 1;
      padding: 5%;
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    #choice {
      width: 80%;
      background-color: #dcdcdc;
      border-radius: 20px;
      align-content: center;
      padding: 5%;
    }
    
    
    input[type=text]{
        -webkit-border-radius: 20px;
        -moz-border-radius: 20px;
         border-radius: 20px;
         border: 2px solid #808080;
         color: #808080;
         height: 30px;
         bottom: 50px;
         margin:auto;
    }
    input[type=text]:focus {
         outline: none;
         border: 2px solid #808080;
         color: #808080;
    }
    input[type="text"], textarea {
  		background-color : #dcdcdc;
    }
    #username {
      width: 20%;
    }
    #sentence {
      width: 80%;
    }

    </style>
  </head>


  <body style="background-color:#dcdcdc;">

    <script type="module">
    
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-app.js";
      import { getDatabase, ref, set, child, push, update, onValue } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBsyNvH0JlTzldg51uWzkadOnYLpewhYVs",
        authDomain: "creativeproject-12185.firebaseapp.com",
        databaseURL: "https://creativeproject-12185-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "creativeproject-12185",
        storageBucket: "creativeproject-12185.appspot.com",
        messagingSenderId: "990833384121",
        appId: "1:990833384121:web:72d1040a139abd74655968"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase();

      let agentType;
      let remoteUser;
      let remoteChar;
      let remoteUserName;
      let remoteSentence = [];

      // Prompt agent choice
      radio1.onclick = function() {
        agentType = 1;
        popup.style.display = "None";

        // Retrieve other user data
        remoteUser = ref(db, 'table/username2');
        remoteChar = ref(db, 'table/charStream2');
        
        onValue(remoteUser, (snapshot) => {
          remoteUserName = snapshot.val();
        });
        onValue(remoteChar, (snapshot) => {
          let remoteUserChar = snapshot.val();
          
          if (remoteUserChar === "%") {
            let chat = document.createElement("div");
            let chatUsername = document.createElement("b");
            chatUsername.innerText = remoteUserName + " (ðŸ› ):";
            chat.appendChild(chatUsername);
            chat.innerHTML += " " + remoteSentence.join('');
            chat.className = "chat";
            area.appendChild(chat);

            remoteSentence = [];
          } else {
            remoteSentence.push(remoteUserChar);
          }
        });
      }
      radio2.onclick = function() {
        agentType = 2;
        popup.style.display = "None";

        // Retrieve other user data
        remoteUser = ref(db, 'table/username1');
        remoteChar = ref(db, 'table/charStream1');
        
        onValue(remoteUser, (snapshot) => {
          remoteUserName = snapshot.val();
        });
        onValue(remoteChar, (snapshot) => {
          let remoteUserChar = snapshot.val();
          
          if (remoteUserChar === "%") {
            let chat = document.createElement("div");
            let chatUsername = document.createElement("b");
            chatUsername.innerText = remoteUserName + " (â™«):";
            chat.appendChild(chatUsername);
            chat.innerHTML += " " + remoteSentence.join('');
            chat.className = "chat";
            area.appendChild(chat);

            remoteSentence = [];
          } else {
            remoteSentence.push(remoteUserChar);
          }
        });
      }

      
      
      // Get username
      username.addEventListener('input', () => {
        const db = getDatabase();
        if (agentType === 1){
          update(ref(db, 'table/'), {
          username1: username.value
          })
        } else if (agentType === 2) {
          update(ref(db, 'table/'), {
          username2: username.value
          })
        }
        
      });

      let printedSentence = [];
      // Get sentence
      sentence.addEventListener('keypress', (e) => { 
        let char = e.key;
        if (char === "Enter") {
          console.log(printedSentence);

          let chat = document.createElement("div");
          let chatUsername = document.createElement("b");
          if (agentType === 1){
            chatUsername.innerText = username.value + " (â™«):";
          } else {
            chatUsername.innerText = username.value + " (ðŸ› ):";
          }  
          chat.appendChild(chatUsername);
          chat.innerHTML += " " + printedSentence.join('');
          chat.className = "chat";
          area.appendChild(chat);
          
          sentence.value = "";
          printedSentence = [];
          
          char = "%";
        } else {
          printedSentence.push(char);
          console.log(char);
        }
        // Send to firebase
        const db = getDatabase();
        if (agentType === 1){
          update(ref(db, 'table/'), {
            charStream1: "",
          })
          update(ref(db, 'table/'), {
            charStream1: char,
          })
        } else if (agentType === 2){
          update(ref(db, 'table/'), {
            charStream2: "",
          })
          update(ref(db, 'table/'), {
            charStream2: char
          })
        }
      });


  </script>

    <div id="rcorners">
      <div id="area">

      </div>
      
    	<div id="wrapper">
        <input id="username" type=text placeholder="Username"></input>
        <input id="sentence" type=text placeholder="Type something..."></input>
      </div>
    </div>

    <div id="popup">
      <div id = "choice">
        Select your agent:
        <br><br>
        <input type="radio" id = "radio1" name="foo" checked=false>Melody maker (â™«)</input>
        <br>
        <input type="radio" id = "radio2" name="foo" checked=false>Melody modifier (ðŸ› )</input>
      </div>
    </div>
	
  </body>


</html>

